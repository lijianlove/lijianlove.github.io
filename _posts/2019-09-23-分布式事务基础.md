---
layout:     post
title:      分布式事务基础
subtitle:   分布式事务基础
date:       2019-09-23
author:     lijian
header-img: img/post-bg-hacker.jpg
catalog: true
tags:
    - 事务
---

### 本地事务与分布式事务

本地事务只会操作一个数据库,分布式事务操作的是多个数据库,所以分布式事务相对本地事务最核心的 获取一个连接,使用连接来 commit , rollback 很明显不适用了


### 核心

* [CAP 定理](http://robertgreiner.com/2014/06/cap-theorem-explained/)

布鲁尔定理,分布式计算领域公认的一个定理

在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉读写操作时，只能保证一致性（Consistence）、可用性(Availability）、分区容错性（Partition）三者中的两个，另外一个必须被牺牲
                          
参考文章 : 分布式事务 CAP
                                                              
* BASE 理论

BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。是对CAP中AP的一个扩展

参考文章 : 分布式事务 BASE

 基本可用
分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。

 软状态
允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致。

 最终一致
最终一致是指经过一段时间后，所有节点数据都将会达到一致。


BASE和 ACID 是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态,是柔性事务的理论支持

* RM

 通常指的是 数据库,也可以是JMS 队列 等
 
* TCC

Try阶段：尝试执行,完成所有业务检查（一致性）,预留必须业务资源（准隔离性）

Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败后需要进行重试。

Cancel阶段：取消执行，释放Try阶段预留的业务资源 Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。

* 2pc

在这种情况下，TPM 将组织一个两阶段提交。在两阶段提交中，TPM 首先向每个 RM 发送一个 “准备” 消息，询问它是否准备就绪以及是否能够提交事务；如果它收到来自所有 RM 的确认应答，则将事务在其自己的事务日志中标记为已提交，然后指示所有 RM 提交事务。如果某个 RM 失败，则重新启动时它将向 TPM 询问有关失败时未处理的所有事务的状态，并提交它们或者对它们执行回滚操作。

两个阶段提交类似于社会上的结婚典礼 —— 牧师或神父询问双方 “您愿意让这个男人/女人作为您的丈夫/妻子吗？” 如果双方都回答是，则将宣布他们成为夫妻；否则，双方不能结婚。不管双方中的哪一方首先说 “我愿意”，在一方没有回答时，另一方决不能完成结婚

* 3pc

* 本地消息表

参考文章:分布式事务-基于可靠消息

* mq 事务


### 最后

能不用分布式事务就不用，如果非得使用的话，结合自己的业务分析，看看自己的业务比较适合哪一种，是在乎强一致，还是最终一致即可


### 巨人的肩膀

[再有人问你分布式事务，把这篇扔给他](https://www.cnblogs.com/bigben0123/p/9453830.html)

[分布式事务详解](https://blog.51cto.com/kankan/2419278)

[大规模SOA系统中的分布式事务处理](http://www.lijianlove.com/index/share/%E5%A4%A7%E8%A7%84%E6%A8%A1SOA%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86_%E7%A8%8B%E7%AB%8B_SD2C2008.pdf)